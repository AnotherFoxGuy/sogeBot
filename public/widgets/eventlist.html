<div class="widget">
  <h6 data-lang="eventlist"></h6>
  <ul class="nav nav-pills" role="tablist">
    <li role="presentation" class="nav-item">
      <a class="nav-link active" href="#eventlist-main" aria-controls="home" role="tab" data-toggle="tab" title="EventList">
        <i class="fa fa-calendar-o" aria-hidden="true"></i>
      </a>
    </li>
    <li role="presentation" class="nav-item">
      <button data-id="follow" class="btn btn-outline-success nav-btn" onclick="eventlist.toggle(this)">
        <i class="fa fa-heart"></i>
      </button>
    </li>
    <li role="presentation" class="nav-item">
      <button data-id="host" class="btn btn-outline-success nav-btn" onclick="eventlist.toggle(this)">
        <i class="fa fa-bullhorn"></i>
      </button>
    </li>
    <li role="presentation" class="nav-item">
      <button data-id="cheer" class="btn btn-outline-success nav-btn" onclick="eventlist.toggle(this)">
        <i class="fa fa-diamond"></i>
      </button>
    </li>
    <li role="presentation" class="nav-item">
      <button data-id="sub" class="btn btn-outline-success nav-btn" onclick="eventlist.toggle(this)">
        <i class="fa fa-star"></i>
      </button>
    </li>
    <li role="presentation" class="nav-item">
      <button data-id="resub" class="btn btn-outline-success nav-btn" onclick="eventlist.toggle(this)">
        <i class="fa fa-star-half-o"></i>
      </button>
    </li>
    <li role="presentation">
      <a class="nav-link" href="#eventlist-settings" aria-controls="home" role="tab" data-toggle="tab" title="Settings">
        <i class="fa fa-cog" aria-hidden="true"></i>
      </a>
    </li>
  </ul>
  <!-- Tab panes -->
  <div class="tab-content">
    <div role="tabpanel" class="tab-pane active" id="eventlist-main">
        <div class="alert alert-primary" role="alert">
          <i class="fa fa-circle-o-notch fa-spin fa-1x fa-fw"></i>
          <strong>loading data...</strong>
        </div>
    </div>
    <!-- /MAIN -->

    <div role="tabpanel" class="tab-pane" id="eventlist-settings">
      <div class="input-group">
        <div class="input-group-prepend">
          <span class="input-group-text" data-lang="eventlist-overflow-height"></span>
        </div>
        <input type="text" class="form-control" id="eventlistOverflowHeight">
        <div class="input-group-append">
          <span class="input-group-text">px</span>
        </div>
      </div>
      <div class="input-group">
        <div class="input-group-prepend">
          <span class="input-group-text" data-lang="eventlist-show-number"></span>
        </div>
        <input type="text" class="form-control" id="eventlistShow">
        <div class="input-group-append">
          <span class="input-group-text" data-lang="eventlist-show"></span>
        </div>
      </div>
      <button type="button" class="btn btn-danger btn-block" onclick="deleteWidget('eventlist')" style="margin-top: 20px;" data-lang="remove-widget"></button>
    </div>
    <!-- /SETTINGS -->
  </div>
</div>

<script>
  var eventlist = {
    config: {},
    toggle: function (el) {
      this.config[el.dataset.id] = !this.config[el.dataset.id]
      $(el).removeClass().addClass('nav-btn btn ' + (this.config[el.dataset.id] ? 'btn-outline-success' : 'btn-outline-danger'))

      socket.emit('saveConfiguration', {
        'widgetEventlistFollows': this.config.follow,
        'widgetEventlistHosts': this.config.host,
        'widgetEventlistCheers': this.config.cheer,
        'widgetEventlistSubs': this.config.sub,
        'widgetEventlistResubs': this.config.resub
      })
      socket.emit('widget.eventlist.get')
    }
  }

  setTimeout(() => socket.emit('widget.eventlist.get'), 5000)

  socket.once('configuration', function (data) {
    if (!data.widgetEventlistFollows) {
      $('button[data-id="follow"]').removeClass().addClass('nav-btn btn btn-outline-danger')
    }
    if (!data.widgetEventlistHosts) {
      $('button[data-id="host"]').removeClass().addClass('nav-btn btn btn-outline-danger')
    }
    if (!data.widgetEventlistCheers) {
      $('button[data-id="cheer"]').removeClass().addClass('nav-btn btn btn-outline-danger')
    }
    if (!data.widgetEventlistSubs) {
      $('button[data-id="sub"]').removeClass().addClass('nav-btn btn btn-outline-danger')
    }
    if (!data.widgetEventlistResubs) {
      $('button[data-id="resub"]').removeClass().addClass('nav-btn btn btn-outline-danger')
    }
    eventlist.config = {
      height: data.widgetEventlistOverflowHeight,
      show: data.widgetEventlistShow,
      follow: data.widgetEventlistFollows,
      host: data.widgetEventlistHosts,
      cheer: data.widgetEventlistCheers,
      sub: data.widgetEventlistSubs,
      resub: data.widgetEventlistResubs
    }

    $('#eventlistShow').val(data.widgetEventlistShow)
    $('#eventlistOverflowHeight').val(data.widgetEventlistOverflowHeight)
  })

  socket.on('widget.eventlist', function (o) {
    if (_.isNil(o)) return

    let colors = {
      follow: 'red',
      host: 'orange',
      sub: 'blue',
      resub: 'indigo',
      cheer: 'yellow'
    }

    let icons = {
        follow: 'heart',
        host: 'bullhorn',
        sub: 'star',
        resub: 'star-half-o',
        cheer: 'diamond'
      }

    let eventlistEl = $('#eventlist-main')
    eventlistEl.empty()
    eventlistEl
      .css('max-height', eventlist.config.height + 'px')
      .css('overflow', 'auto')

    let i = 0
    for (let event of o) {
      if (!(eventlist.config[event.event])) continue
      i++

      let username
      let timestamp = moment(event.timestamp).fromNow()
      let icon = `<i title="${moment(event.timestamp).format('LLLL')}" class="eventlist-text">${moment(event.timestamp).fromNow()}</i>`
      let t = translations['eventlist-events'][event.event]
      if (event.event === 'follow') {
        username = `<div class="col-9 eventlist-username">
          <div title="${event.username}" style="z-index: 9">${event.username}</div>
          <span style="font-size:0.7rem; font-weight: normal">${t}</span>
          <i class="fa fa-${icons[event.event]}" style="position: absolute; right: 1rem; top: .4rem; font-size: 1rem; opacity: 0.4; color: ${colors[event.event]}" aria-hidden="true"></i>
        </div>`
      }

      if (event.event === 'host') {
        username = `<div class="col-9 eventlist-username">
          <div title="${event.username}" style="z-index: 9">${event.username}</div>
          <span style="font-size:0.7rem; font-weight: normal">${t.replace('$viewers', '<strong>' + _.get(event, 'viewers', '0') + '</strong>')}</span>
          <i class="fa fa-${icons[event.event]}" style="position: absolute; right: 1rem; top: .4rem; font-size: 1rem; opacity: 0.4; color: ${colors[event.event]}" aria-hidden="true"></i>
        </div>`
      }

      if (event.event === 'sub') {
        username = `<div class="col-9 eventlist-username">
          <div title="${event.username}" style="z-index: 9">${event.username}</div>
          <span style="font-size:0.7rem; font-weight: normal">${t}</span>
          <i class="fa fa-${icons[event.event]}" style="position: absolute; right: 1rem; top: .4rem; font-size: 1rem; opacity: 0.4; color: ${colors[event.event]}" aria-hidden="true"></i>
        </div>`
      }

      if (event.event === 'resub') {
        username = `<div class="col-9 eventlist-username">
          <div title="${event.username}" style="z-index: 9">${event.username}</div>
          <span style="font-size:0.7rem; font-weight: normal">${t.replace('$months', '<strong>' + _.get(event, 'months', '0') + '</strong>')}</span>
          <i class="fa fa-${icons[event.event]}" style="position: absolute; right: 1rem; top: .4rem; font-size: 1rem; opacity: 0.4; color: ${colors[event.event]}" aria-hidden="true"></i>
        </div>`
      }

      if (event.event === 'cheer') {
        username = `<div class="col-9 eventlist-username">
          <div title="${event.username}" style="z-index: 9">${event.username}</div>
          <span style="font-size:0.7rem; font-weight: normal">${t.replace('$bits', '<strong>' + _.get(event, 'bits', '0') + '</strong>')}</span>
          <i class="fa fa-${icons[event.event]}" style="position: absolute; right: 1rem; top: .4rem; font-size: 1rem; opacity: 0.4; color: ${colors[event.event]}" aria-hidden="true"></i>
        </div>`
      }

      let row = `<div class="row">
        <div class="col-3">${icon}</div>
        ${username}
        </div>`

      eventlistEl.append(row)
      if (i >= eventlist.config.show) break
    }
  })

  var $eventlistShow = $('#eventlistShow')
  $eventlistShow.off()
  $eventlistShow.on('focusout', function () {
    var value = $eventlistShow.val()
    var data = {}
    data['widgetEventlistShow'] = value
    eventlist.config.show = value
    socket.emit('saveConfiguration', data)
  })

var $eventlistOverflow = $('#eventlistOverflowHeight')
$eventlistOverflow.off()
$eventlistOverflow.on('focusout', function () {
  var value = $eventlistOverflow.val()
  var data = {}
  data['widgetEventlistOverflowHeight'] = value
  eventlist.config.height = value
  socket.emit('saveConfiguration', data)
})
</script>
